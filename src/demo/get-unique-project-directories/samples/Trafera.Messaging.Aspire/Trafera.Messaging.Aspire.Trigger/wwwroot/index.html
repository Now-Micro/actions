<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trafera Warranty Trigger</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: radial-gradient(circle at 10% 20%, #0f172a 0, #0b1222 35%, #080e1b 70%, #060b15 100%);
            --panel: rgba(255, 255, 255, 0.04);
            --panel-border: rgba(255, 255, 255, 0.08);
            --accent: #38bdf8;
            --accent-2: #a78bfa;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --shadow: 0 25px 80px rgba(0, 0, 0, 0.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
            color: var(--text);
            font-family: "JetBrains Mono", "Cascadia Code", "Consolas", monospace;
            letter-spacing: -0.01em;
            display: flex;
            justify-content: center;
            padding: 32px 16px;
        }

        main {
            width: min(1200px, 100%);
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 24px;
        }

        .title {
            font-size: clamp(26px, 4vw, 34px);
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .subtitle {
            color: var(--muted);
            max-width: 820px;
            line-height: 1.5;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 18px 18px 14px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px);
        }

        .panel h2 {
            margin: 0 0 12px 0;
            font-size: 18px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
            letter-spacing: 0.02em;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--panel-border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s ease, background 0.15s ease;
        }

        input:focus {
            border-color: var(--accent);
            background: rgba(56, 189, 248, 0.08);
        }

        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 14px;
        }

        button {
            appearance: none;
            border: none;
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 700;
            color: #0b1222;
            background: linear-gradient(120deg, var(--accent), var(--accent-2));
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(56, 189, 248, 0.35);
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 44px rgba(56, 189, 248, 0.45);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(56, 189, 248, 0.14);
            color: var(--accent);
            font-size: 12px;
            font-weight: 700;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        .log {
            font-size: 13px;
            line-height: 1.55;
            color: var(--muted);
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 6px;
        }

        .log strong {
            color: var(--text);
        }

        .note {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }
    </style>
</head>

<body>
    <main>
        <header>
            <div class="badge">Local-only â€¢ RabbitMQ</div>
            <div class="title">Trafera Warranty Trigger</div>
            <div class="subtitle">Simulate incoming device events and push them onto the bus that
                Trafera.WarrantyService listens to. Use this to exercise the end-to-end intake and warranty lookup flow
                without touching upstream systems.</div>
        </header>

        <section class="grid">
            <div class="panel">
                <h2>Device Created</h2>
                <form data-endpoint="/api/device-created">
                    <label for="create-serial">Serial Number</label>
                    <input id="create-serial" name="serialNumber" value="1TW2N34">

                    <label for="create-customer">Customer Number</label>
                    <input id="create-customer" name="customerNumber" value="94429">

                    <div class="row">
                        <div>
                            <label for="create-manufacturer">Manufacturer</label>
                            <input id="create-manufacturer" name="manufacturer" value="Dell">
                        </div>
                        <div>
                            <label for="create-source">Source System (optional)</label>
                            <input id="create-source" name="sourceSystem" value="Trigger">
                        </div>
                    </div>

                    <label for="create-requested">Requested By (optional)</label>
                    <input id="create-requested" name="requestedBy" value="you@trafera.com">

                    <div class="actions">
                        <div class="note">Sends a MassTransit <strong>DeviceCreated</strong> message.</div>
                        <button type="submit">Publish</button>
                    </div>
                </form>
            </div>

            <div class="panel">
                <h2>Device Updated</h2>
                <form data-endpoint="/api/device-updated">
                    <label for="update-serial">Serial Number</label>
                    <input id="update-serial" name="serialNumber" value="YX0940W4" required>

                    <label for="update-customer">Customer Number</label>
                    <input id="update-customer" name="customerNumber" value="85401" required>

                    <div class="row">
                        <div>
                            <label for="update-manufacturer">Manufacturer</label>
                            <input id="update-manufacturer" name="manufacturer" value="Lenovo" required>
                        </div>
                        <div>
                            <label for="update-source">Source System (optional)</label>
                            <input id="update-source" name="sourceSystem" value="Trigger">
                        </div>
                    </div>

                    <label for="update-requested">Requested By (optional)</label>
                    <input id="update-requested" name="requestedBy" value="qa@trafera.com">

                    <div class="actions">
                        <div class="note">Sends a MassTransit <strong>DeviceUpdated</strong> message.</div>
                        <button type="submit">Publish</button>
                    </div>
                </form>
            </div>
        </section>

        <section class="panel" style="margin-top: 16px;">
            <h2>Misc Test Cases</h2>
            <span>Can add buttons to trigger different event/command or multiple events/commands at one time</span>
        </section>

        <section class="panel" style="margin-top: 16px;">
            <h2>Activity</h2>
            <pre class="log" id="log">Waiting for events...</pre>
        </section>
    </main>

    <script>
        const logArea = document.getElementById('log');

        const writeLog = (text) => {
            const now = new Date().toLocaleTimeString();
            logArea.textContent = `[${now}] ${text}\n` + (logArea.textContent || '');
        };

        const publishEvent = async (endpoint, data) => {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const payload = await response.json();

            if (!response.ok) {
                const details = JSON.stringify(payload.errors ?? payload, null, 2);
                const error = new Error(details);
                error.name = 'PublishError';
                throw error;
            }

            return payload;
        };

        const handleSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const endpoint = form.dataset.endpoint;
            const data = Object.fromEntries(new FormData(form).entries());

            try {
                const payload = await publishEvent(endpoint, data);
                writeLog(`Published ${payload.published} for ${payload.serialNumber ?? 'n/a'} / ${payload.customerNumber ?? 'n/a'}`);
            } catch (err) {
                if (err.name === 'PublishError') {
                    writeLog(`Failed: ${err.message}`);
                    return;
                }

                writeLog(`Error: ${err.message}`);
            }
        };

        document.querySelectorAll('form[data-endpoint]').forEach(form => {
            form.addEventListener('submit', handleSubmit);
        });

        const deviceCreatedForm = document.querySelector('form[data-endpoint="/api/device-created"]');
        const multiPublishButton = document.getElementById('publish-multiple-device-created');
        const multiPublishCountInput = document.getElementById('multi-publish-count');

        const csiTargets = [
            { serial: '16T5W54', customerNumber: '94429' },
            { serial: '1TW2N34', customerNumber: '94429' },
            { serial: '5CD234J', customerNumber: '94429' },
        ];
        const dellTargets = [
            { serial: '1BPX353', customerNumber: 'CUST-DELL-EXISTS' },
            { serial: '1BPX359', customerNumber: 'CUST-DELL-DOES_NOT_EXIST' },
        ];
        const lenovoTargets = [
            { serial: 'MJ065Y4C', customerNumber: 'CUST-LENOVO-EXISTS' },
            { serial: 'MJ065AAA', customerNumber: 'CUST-LENOVO-DOES_NOT_EXIST' },
        ];
        const csiPublishButton = document.getElementById('publish-csi-batch');
        const csiCustomerInput = document.getElementById('csi-customer');
        const csiRequestedInput = document.getElementById('csi-requested');
        const csiSourceInput = document.getElementById('csi-source');

        const varyingCustomerButton = document.getElementById('publish-varying-customer');
        const varyingRequestedInput = document.getElementById('varying-requested');
        const varyingSourceInput = document.getElementById('varying-source');

        const miscBaseSerial = '1BPX353';
        const miscSerialMatch = miscBaseSerial.match(/^(.*?)(\d+)$/);
        const miscSerialPrefix = miscSerialMatch ? miscSerialMatch[1] : miscBaseSerial;
        const miscSerialStartNumber = miscSerialMatch ? parseInt(miscSerialMatch[2], 10) : 0;
        const miscSerialNumberLength = miscSerialMatch ? miscSerialMatch[2].length : 0;

        const buildMiscSerials = (count) => {
            return Array.from({ length: count }, (_, index) => {
                if (!miscSerialMatch) {
                    return index === 0 ? miscBaseSerial : `${miscBaseSerial}-${index + 1}`;
                }

                const currentNumber = (miscSerialStartNumber + index).toString().padStart(miscSerialNumberLength, '0');
                return `${miscSerialPrefix}${currentNumber}`;
            });
        };

        if (deviceCreatedForm && multiPublishButton) {
            multiPublishButton.addEventListener('click', async () => {
                const endpoint = deviceCreatedForm.dataset.endpoint;
                if (!endpoint) {
                    return;
                }

                const count = parseInt(multiPublishCountInput?.value ?? '5', 10);
                if (!Number.isFinite(count) || count <= 0) {
                    writeLog('Failed: Provide a positive event count.');
                    return;
                }

                const serials = buildMiscSerials(count);
                const baseData = Object.fromEntries(new FormData(deviceCreatedForm).entries());

                multiPublishButton.disabled = true;

                try {
                    for (const serial of serials) {
                        const payload = await publishEvent(endpoint, { ...baseData, serialNumber: serial });
                        writeLog(`Published ${payload.published} for ${payload.serialNumber ?? 'n/a'} / ${payload.customerNumber ?? 'n/a'}`);
                    }
                } catch (err) {
                    if (err.name === 'PublishError') {
                        writeLog(`Failed: ${err.message}`);
                    } else {
                        writeLog(`Error: ${err.message}`);
                    }
                } finally {
                    multiPublishButton.disabled = false;
                }
            });
        }

        if (deviceCreatedForm && csiPublishButton) {
            csiPublishButton.addEventListener('click', async () => {
                const endpoint = deviceCreatedForm.dataset.endpoint;
                if (!endpoint) {
                    return;
                }

                const baseData = Object.fromEntries(new FormData(deviceCreatedForm).entries());
                const customerNumber = csiCustomerInput?.value || baseData.customerNumber;
                const requestedBy = csiRequestedInput?.value || baseData.requestedBy;
                const sourceSystem = csiSourceInput?.value || baseData.sourceSystem;
                const publishManufacturerSeries = async (targets, manufacturerName) => {
                    for (const { serial, customerNumber: targetCustomer } of targets) {
                        const payload = await publishEvent(endpoint, {
                            ...baseData,
                            serialNumber: serial,
                            customerNumber: targetCustomer,
                            manufacturer: manufacturerName,
                            requestedBy,
                            sourceSystem,
                        });
                        writeLog(
                            `Published ${payload.published} for ${payload.serialNumber ?? 'n/a'} / ${payload.customerNumber ?? 'n/a'} (${manufacturerName})`
                        );
                    }
                };

                csiPublishButton.disabled = true;

                try {
                    await publishManufacturerSeries(csiTargets, 'CSI');
                    await publishManufacturerSeries(dellTargets, 'Dell');
                    await publishManufacturerSeries(lenovoTargets, 'Lenovo');
                } catch (err) {
                    if (err.name === 'PublishError') {
                        writeLog(`Failed: ${err.message}`);
                    } else {
                        writeLog(`Error: ${err.message}`);
                    }
                } finally {
                    csiPublishButton.disabled = false;
                }
            });
        }

        if (deviceCreatedForm && varyingCustomerButton) {
            varyingCustomerButton.addEventListener('click', async () => {
                const endpoint = deviceCreatedForm.dataset.endpoint;
                if (!endpoint) {
                    return;
                }

                const baseData = Object.fromEntries(new FormData(deviceCreatedForm).entries());
                const requestedBy = varyingRequestedInput?.value || baseData.requestedBy;
                const sourceSystem = varyingSourceInput?.value || baseData.sourceSystem;
                const serial = 'MZ02Y9TH';
                const customers = ['CUST-001', 'CUST-002', 'CUST-CSI'];
                const manufacturers = ['CSI', 'HP', 'Dynabook'];

                varyingCustomerButton.disabled = true;

                try {
                    for (let i = 0; i < customers.length; i++) {
                        const payload = await publishEvent(endpoint, {
                            ...baseData,
                            serialNumber: serial,
                            customerNumber: customers[i],
                            manufacturer: manufacturers[i % manufacturers.length],
                            requestedBy,
                            sourceSystem,
                        });
                        writeLog(`Published ${payload.published} for ${payload.serialNumber ?? 'n/a'} / ${payload.customerNumber ?? 'n/a'}`);
                    }
                } catch (err) {
                    if (err.name === 'PublishError') {
                        writeLog(`Failed: ${err.message}`);
                    } else {
                        writeLog(`Error: ${err.message}`);
                    }
                } finally {
                    varyingCustomerButton.disabled = false;
                }
            });
        }
    </script>
</body>

</html>