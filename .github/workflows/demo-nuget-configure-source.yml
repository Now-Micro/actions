name: Demo - Nuget Configure Source

on:
  workflow_dispatch:

jobs:
  direct-configure:
    name: Direct configure-sources usage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Configure multiple NuGet sources (direct)
        uses: ./nuget/configure-sources
        with:
          debug-mode: "true"
          names: "DemoSource1, DemoSource2"
          usernames: "demo-user-1, demo-user-2"
          passwords: "demo-pass-1, demo-pass-2"
          urls: "https://example.invalid/feed1/index.json, https://example.invalid/feed2/index.json"

      - name: List configured NuGet sources
        run: dotnet nuget list source

  skips-configure:
    name: Skips configuring due to missing value
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Configure multiple NuGet sources (direct)
        uses: ./nuget/configure-sources
        with:
          debug-mode: "true"
          usernames: "demo-user-1, demo-user-2"
          passwords: "demo-pass-1, demo-pass-2"
          urls: "https://example.invalid/feed1/index.json, https://example.invalid/feed2/index.json"

      - name: List configured NuGet sources
        run: dotnet nuget list source

  skips-configure-due-to-already-existing:
    name: Skips due to already existing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Configure multiple NuGet sources (initial)
        uses: ./nuget/configure-sources
        with:
          debug-mode: "true"
          usernames: ${{ github.actor }}
          passwords: ${{ secrets.GITHUB_TOKEN }}
          names: "CodeBits"
          urls: "https://nuget.pkg.github.com/Now-Micro/index.json"

      - name: Configure multiple NuGet sources (second time)
        uses: ./nuget/configure-sources
        with:
          debug-mode: "true"
          usernames: ${{ github.actor }}
          passwords: ${{ secrets.GITHUB_TOKEN }}
          names: "CodeBits"
          urls: "https://nuget.pkg.github.com/Now-Micro/index.json"

      - name: List configured NuGet sources
        run: dotnet nuget list source

  skips-even-if-casing-different:
    name: Skips even if casing is different
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Configure multiple NuGet sources (initial)
        uses: ./nuget/configure-sources
        with:
          debug-mode: "true"
          usernames: ${{ github.actor }}
          passwords: ${{ secrets.GITHUB_TOKEN }}
          names: "CodeBits"
          urls: "https://incorrecturl.com/index.json"

      - name: Should Update codebits url
        uses: ./nuget/configure-sources
        with:
          debug-mode: "true"
          usernames: ${{ github.actor }}
          passwords: ${{ secrets.GITHUB_TOKEN }}
          names: "codebIts"
          urls: "https://nuget.pkg.github.com/Now-Micro/index.json"

      - name: List configured NuGet sources
        id: list-sources
        run: |
          dotnet nuget list source | tee nuget-sources.txt
          {
            echo "list<<'EOF'"
            cat nuget-sources.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Assert Url is updated
        uses: ./src/testing/assert
        with:
          test-name: nuget-codebits-url
          mode: regex
          expected: 'CodeBits[\s\S]*https://nuget.pkg.github.com/Now-Micro/index.json'
          actual: ${{ steps.list-sources.outputs.list }}

      - name: Should Add remove Code-Bits and add Now-Micro instead
        uses: ./nuget/configure-sources
        with:
          debug-mode: "true"
          usernames: ${{ github.actor }}
          passwords: ${{ secrets.GITHUB_TOKEN }}
          names: "Now-Micro"
          urls: "https://nuget.pkg.github.com/Now-Micro/index.json"

      - name: List configured NuGet sources (after rename)
        id: list-sources-final
        run: |
          dotnet nuget list source | tee nuget-sources-final.txt
          {
            echo "final_list<<'EOF'"
            cat nuget-sources-final.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Assert Now-Micro is present
        uses: ./src/testing/assert
        with:
          test-name: nuget-now-micro-url
          mode: regex
          expected: 'Now-Micro[\s\S]*https://nuget.pkg.github.com/Now-Micro/index.json'
          actual: ${{ steps.list-sources-final.outputs.final_list }}

      - name: Assert CodeBits is gone
        uses: ./src/testing/assert
        with:
          test-name: nuget-codebits-absent
          mode: absent
          expected: CodeBits
          actual: ${{ steps.list-sources-final.outputs.final_list }}
