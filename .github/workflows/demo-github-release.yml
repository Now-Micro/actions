name: Demo - GitHub Release

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    demo-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Check out repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set demo variables
              run: |
                  echo "LIB_NAME=Demo.Library" >> $GITHUB_ENV
                  echo "RELEASE_VERSION=0.0.0-demo-${GITHUB_RUN_ID}" >> $GITHUB_ENV
                  echo "ARTIFACTS_DIR=demo-artifacts" >> $GITHUB_ENV
                  echo "PACKAGES_DIR=demo-packages" >> $GITHUB_ENV
                  echo "BODY_FILE=DEMO_NOTES_${GITHUB_RUN_ID}.md" >> $GITHUB_ENV
                  echo "SUMMARY_FILE=$GITHUB_WORKSPACE/demo-github-release-summary.txt" >> $GITHUB_ENV

            - name: Prepare summary file
              run: |
                  : > "$SUMMARY_FILE"

            - name: Clean existing demo release (best-effort)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  gh release delete "${LIB_NAME}-v${RELEASE_VERSION}" -y >/dev/null 2>&1 || true
                  git push origin ":refs/tags/${LIB_NAME}-v${RELEASE_VERSION}" >/dev/null 2>&1 || true

            - name: Create fake artifacts
              run: |
                  mkdir -p "$ARTIFACTS_DIR/nested"
                  echo "pkg1" > "$ARTIFACTS_DIR/one.nupkg"
                  echo "pkg2" > "$ARTIFACTS_DIR/nested/two.snupkg"
                  cat <<EOF > "$ARTIFACTS_DIR/CHANGELOG.md"
                  # Changelog

                  All notable changes to this project will be documented in this file.

                  The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
                  and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

                  ## [${RELEASE_VERSION}] - 2025-07-29

                  ### Added

                  - Some new stuff

                  ### Changed

                  - Some old stuff

                  ### Updated 

                  - Something

                  ### Random Thing

                  - Another thing

                  ## [1.2.0] - 2025-07-21

                  ### Added

                  - Older feature (not used)

                  ## [1.0.0] - 2025-07-21

                  ### Added

                  - Legacy entry (not used)
                  EOF

            - name: Run github/release (creates real release)
              id: release
              uses: ./github/release
              with:
                  library-name: ${{ env.LIB_NAME }}
                  release-version: ${{ env.RELEASE_VERSION }}
                  artifacts-path: ${{ env.ARTIFACTS_DIR }}
                  packages-path: ${{ env.PACKAGES_DIR }}
                  changelog-path: ${{ env.ARTIFACTS_DIR }}/CHANGELOG.md
                  skip-download: true
                  dry-run: false
                  debug-mode: true
                  body-filename: ${{ env.BODY_FILE }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Assert tag name
              uses: ./src/testing/assert
              with:
                  test-name: "tag name"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: ${{ env.LIB_NAME }}-v${{ env.RELEASE_VERSION }}
                  actual: ${{ steps.release.outputs.tag-name || '' }}

            - name: Assert release name
              uses: ./src/testing/assert
              with:
                  test-name: "release name"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: ${{ env.LIB_NAME }} v${{ env.RELEASE_VERSION }}
                  actual: ${{ steps.release.outputs.release-name || '' }}

            - name: Assert packages copied
              uses: ./src/testing/assert
              with:
                  test-name: "has packages"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: "2"
                  actual: ${{ steps.release.outputs.has-packages || '' }}

            - name: Assert packages json
              uses: ./src/testing/assert
              with:
                  test-name: "packages json"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: '["one.nupkg","two.snupkg"]'
                  actual: ${{ steps.release.outputs.packages-json || '' }}

            - name: Assert changelog content in notes
              run: |
                  grep -q "Some new stuff" "${{ steps.release.outputs.release-notes-path }}"

            - name: Fetch created release
              id: api
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  gh api "repos/${{ github.repository }}/releases/tags/${{ steps.release.outputs.tag-name }}" > release.json
                  echo "api_release_name=$(jq -r '.name' release.json)" >> "$GITHUB_OUTPUT"
                  echo "api_tag_name=$(jq -r '.tag_name' release.json)" >> "$GITHUB_OUTPUT"
                  echo "api_assets=$(jq -r '.assets | length' release.json)" >> "$GITHUB_OUTPUT"
                  jq -r '.assets[].name' release.json | sort > asset_names_sorted.txt
                  echo "api_asset_names=$(paste -sd ',' asset_names_sorted.txt)" >> "$GITHUB_OUTPUT"
                  if jq -r '.body' release.json | grep -qi "Some new stuff"; then
                    echo "api_body_has_changelog=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "api_body_has_changelog=false" >> "$GITHUB_OUTPUT"
                  fi
                  jq -r "\"tag=\(.tag_name)\nname=\(.name)\nassets=\(.assets[].name)\"" release.json >> "$SUMMARY_FILE"

            - name: Assert API tag matches
              uses: ./src/testing/assert
              with:
                  test-name: "api tag"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: ${{ steps.release.outputs.tag-name || '' }}
                  actual: ${{ steps.api.outputs.api_tag_name || '' }}

            - name: Assert API release name matches
              uses: ./src/testing/assert
              with:
                  test-name: "api release name"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: ${{ steps.release.outputs.release-name || '' }}
                  actual: ${{ steps.api.outputs.api_release_name || '' }}

            - name: Assert API asset count
              uses: ./src/testing/assert
              with:
                  test-name: "api assets count"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: "2"
                  actual: ${{ steps.api.outputs.api_assets || '' }}

            - name: Assert API asset names
              uses: ./src/testing/assert
              with:
                  test-name: "api asset names"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: "one.nupkg,two.snupkg"
                  actual: ${{ steps.api.outputs.api_asset_names || '' }}

            - name: Assert API body has changelog
              uses: ./src/testing/assert
              with:
                  test-name: "api body changelog"
                  summary-file: ${{ env.SUMMARY_FILE }}
                  mode: exact
                  expected: "true"
                  actual: ${{ steps.api.outputs.api_body_has_changelog || '' }}

            - name: Publish summary
              run: |
                  cat "$SUMMARY_FILE" >> "$GITHUB_STEP_SUMMARY"
